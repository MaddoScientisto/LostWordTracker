@page "/edit"
@using LostWordTracker.Data
@using System.Collections.ObjectModel
@using LostWordTracker.Services
@using System.Text.Json
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService _localStorage
@inject IDataService _dataService

<h1>Edit</h1>

<Button Color="Color.Primary" Clicked="@AddPressed">Add</Button>

<Button Color="Color.Primary" Clicked="@ExportJson">Export JSON</Button>

@if (_characters != null && _characters.Count > 0)
{
    <CardDeck>
        <Repeater Items="_characters" TItem="CharacterDefinition">

            <Card>
                <CardHeader>@context.Id @context.Name</CardHeader>
                <CardBody>
                    <Field>
                        <FieldLabel>Id</FieldLabel>
                        <NumericEdit @bind-Value="@context.Id"></NumericEdit>
                    </Field>
                    <Field>
                        <FieldLabel>Name</FieldLabel>
                        <TextEdit @bind-Text="@context.Name"></TextEdit>
                    </Field>
                    <Field>
                        <FieldLabel>Universe</FieldLabel>
                        <TextEdit @bind-Text="@context.Universe"></TextEdit>
                    </Field>
                    <Field>
                        <FieldLabel>Tier</FieldLabel>
                        <TextEdit @bind-Text="@context.Tier"></TextEdit>
                    </Field>
                    <Field>
                        <FieldLabel>Portrait</FieldLabel>
                        <TextEdit @bind-Text="@context.Portrait"></TextEdit>
                    </Field>

                </CardBody>
            </Card>
        </Repeater>
    </CardDeck>
    <Button Color="Color.Primary" Clicked="@AddPressed">Add</Button>

    <Button Color="Color.Primary" Clicked="@ExportJson">Export JSON</Button>

    @if (_characterToAdd != null)
    {
        <Modal @ref="modalRef">
            <ModalContent Centered>
                <ModalHeader>
                    <ModalTitle>Character edit</ModalTitle>
                    <CloseButton />
                </ModalHeader>
                <ModalBody>
                    <Field>
                        <FieldLabel>Id</FieldLabel>
                        <NumericEdit @bind-Value="@_characterToAdd.Id"></NumericEdit>
                    </Field>
                    <Field>
                        <FieldLabel>Name</FieldLabel>
                        <TextEdit @bind-Text="@_characterToAdd.Name"></TextEdit>
                    </Field>
                    <Field>
                        <FieldLabel>Universe</FieldLabel>
                        <TextEdit @bind-Text="@_characterToAdd.Universe"></TextEdit>
                    </Field>
                    <Field>
                        <FieldLabel>Tier</FieldLabel>
                        <TextEdit @bind-Text="@_characterToAdd.Tier"></TextEdit>
                    </Field>
                    <Field>
                        <FieldLabel>Portrait</FieldLabel>
                        <TextEdit @bind-Text="@_characterToAdd.Portrait"></TextEdit>
                    </Field>
                </ModalBody>
                <ModalFooter>
                    <Button Color="Color.Secondary" Clicked="@HideModal">Close</Button>
                    <Button Color="Color.Primary" Clicked="@SaveNewChar">Save Changes</Button>
                </ModalFooter>
            </ModalContent>
        </Modal>
    }


    <Modal @ref="jsonModalRef">
        <ModalContent Centered>
            <ModalHeader>
                <ModalTitle>JSON Export</ModalTitle>
                <CloseButton />
            </ModalHeader>
            <ModalBody>

                <Field>
                    <FieldLabel>JSON</FieldLabel>
                    <MemoEdit @bind-Text="@_jsonToExport" AutoSize></MemoEdit>
                </Field>

            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary" Clicked="@HideJsonModal">Close</Button>

            </ModalFooter>
        </ModalContent>
    </Modal>


}



@code {
    private Modal modalRef;
    private Modal jsonModalRef;
    //private CharacterDefinitions _characterDefinitions;

    private ObservableCollection<CharacterDefinition> _characters { get; set; } = new();

    private CharacterDefinition _characterToAdd;

    private string _jsonToExport = "";
    protected override async Task OnInitializedAsync()
    {

        var characterDefinitions = await _dataService.GetCharactersData();
        _characters = new(characterDefinitions.Characters.Values.ToArray());
        MakeNewCharacter();
    }

    private void MakeNewCharacter()
    {
        _characterToAdd = new CharacterDefinition() { Id = _characters.Count() + 1 };
    }

    private async Task AddPressed()
    {
        MakeNewCharacter();
        await modalRef.Show();
    }

    private async Task HideModal()
    {
        await modalRef.Hide();
    }

    private async Task SaveNewChar()
    {
        // TODO Save

        _characters.Add(_characterToAdd);

        await modalRef.Hide();
    }

    private async Task ExportJson()
    {
        var dic = _characters.ToDictionary(x => x.Id);

        var objectToConvert = new
        {
            Characters = dic
        };

        _jsonToExport = JsonSerializer.Serialize(objectToConvert, new JsonSerializerOptions { WriteIndented = true });

        await jsonModalRef.Show();
    }

    private async Task HideJsonModal()
    {
        await jsonModalRef.Hide();
    }
}